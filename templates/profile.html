{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-lg-8">
    <!-- Header card -->
    <div class="card shadow-sm mb-4">
      <div class="card-body d-flex flex-column flex-md-row align-items-center">
        <div class="me-md-4 mb-3 mb-md-0 text-center">
          <!-- Clickable avatar -->
          <img id="avatar-display"
               src="{{ user.avatar_url }}"
               class="rounded-circle mb-2"
               width="96"
               height="96"
               alt="avatar"
               style="cursor:pointer;">
          <div class="small text-muted">Tap to change photo</div>

          <div class="badge bg-success-subtle text-success mt-2">
            {{ user.plants_identified }} plants identified
          </div>
        </div>
        <div class="flex-grow-1">
          <h4 class="mb-1">{{ user.name }}</h4>
          <p class="text-muted small mb-2">{{ user.email }}</p>
          {% if user.bio %}
            <p class="mb-0">{{ user.bio }}</p>
          {% else %}
            <p class="text-muted mb-0">Add a short bio to share your plant interests.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Edit profile card -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="mb-3">Edit profile</h5>

        <!-- enctype is required for file upload -->
        <form id="profile-form"
              method="POST"
              action="{{ url_for('profile') }}"
              enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Display name</label>
              <input name="name" type="text" class="form-control" value="{{ user.name }}" required>
            </div>
          </div>

          <!-- Hidden file input, triggered by clicking the avatar -->
          <input id="avatar-file"
                 type="file"
                 name="avatar_file"
                 accept="image/*"
                 style="display:none;">

          <div class="mb-3">
            <label class="form-label">Bio</label>
            <textarea name="bio"
                      rows="3"
                      class="form-control"
                      placeholder="Tell others about your favorite plants, hobbies, etc.">{{ user.bio or '' }}</textarea>
          </div>

         <div class="d-flex gap-2 mt-3">
  <button class="btn btn-success" type="submit">
    Save changes
  </button>

  <button class="btn btn-outline-danger"
          formaction="{{ url_for('reset_profile') }}"
          formmethod="POST">
    Reset Profile
  </button>
</div>

</button>

        </form>
      </div>
    </div>

    <!-- Recent identifications -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">Recent Plant Identifications</h5>
        {% if history %}
          <div class="row">
            {% for item in history %}
              <div class="col-md-4 mb-3">
                <div class="card plant-card h-100">
                  <img src="{{ url_for('uploaded_file', filename=item.filename) }}"
                       class="card-img-top plant-thumb" alt="">
                  <div class="card-body">
                    <h6 class="card-title mb-1">{{ item.common_name or item.plant_name }}</h6>
                    <p class="text-muted small mb-1">{{ item.plant_name }}</p>
                    <p class="text-success small mb-0">{{ (item.confidence * 100)|round(0) }}% match</p>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">You have not identified any plants yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>
{% endblock %}
